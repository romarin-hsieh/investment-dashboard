<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YFinance Errors Diagnosis</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .result { margin: 10px 0; padding: 15px; border-radius: 8px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .critical { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; font-weight: bold; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 8px; font-size: 14px; }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        .test-steps { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 15px 0; border: 1px solid #e9ecef; }
        code { background: #f1f1f1; padding: 3px 6px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 13px; }
        .console-output { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; margin: 10px 0; max-height: 300px; overflow-y: auto; }
        .error-item { background: #fed7d7; color: #c53030; padding: 8px; margin: 5px 0; border-radius: 4px; }
        .success-item { background: #c6f6d5; color: #2f855a; padding: 8px; margin: 5px 0; border-radius: 4px; }
        .warning-item { background: #fefcbf; color: #d69e2e; padding: 8px; margin: 5px 0; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>ğŸ” YFinance éŒ¯èª¤è¨ºæ–·å·¥å…·</h1>
    
    <div class="result critical">
        <strong>ğŸš¨ æ ¹æ“šæˆªåœ–è§€å¯Ÿåˆ°çš„å•é¡Œï¼š</strong>
        <br><br>
        <strong>1. ç¶²è·¯è«‹æ±‚è¢«é˜»æ“‹</strong> - çœ‹åˆ°å¤šå€‹ <code>net::ERR_BLOCKED_BY_CLIENT</code> éŒ¯èª¤
        <br><strong>2. CORS æ”¿ç­–å•é¡Œ</strong> - Content Security Policy é™åˆ¶
        <br><strong>3. TradingView è¼‰å…¥éŒ¯èª¤</strong> - Widget ç›¸é—œå•é¡Œ
        <br><br>
        <strong>é€™äº›å•é¡Œæœƒå°è‡´ YFinance è³‡æ–™ç„¡æ³•è¼‰å…¥ï¼Œé¡¯ç¤º "yfKeys: none"</strong>
    </div>

    <div class="test-steps">
        <h3>ğŸ¯ ç«‹å³è¨ºæ–·æ­¥é©Ÿï¼š</h3>
        <ol>
            <li><strong>æª¢æŸ¥ç•¶å‰é é¢é¡å‹</strong> - ç¢ºèªæ˜¯å¦åœ¨æ­£ç¢ºçš„ Stock Detail é é¢</li>
            <li><strong>æ¸¬è©¦ç¶²è·¯è«‹æ±‚</strong> - æª¢æŸ¥ API æ˜¯å¦å¯ä»¥æ­£å¸¸è¨ªå•</li>
            <li><strong>æª¢æŸ¥å»£å‘Šæ””æˆªå™¨</strong> - æš«æ™‚åœç”¨å»£å‘Šæ””æˆªå™¨</li>
            <li><strong>æ¸¬è©¦ç·Šæ€¥ä¿®å¾©</strong> - æª¢æŸ¥çµ„ä»¶å…§å»ºçš„æ¸¬è©¦è³‡æ–™</li>
            <li><strong>é©—è­‰éƒ¨ç½²ç‰ˆæœ¬</strong> - ç¢ºèªæ˜¯å¦ç‚ºæœ€æ–°ç‰ˆæœ¬</li>
        </ol>
    </div>

    <button onclick="runFullDiagnosis()" class="success">ğŸš€ åŸ·è¡Œå®Œæ•´è¨ºæ–·</button>
    <button onclick="testNetworkRequests()">ğŸŒ æ¸¬è©¦ç¶²è·¯è«‹æ±‚</button>
    <button onclick="checkAdBlocker()">ğŸ›¡ï¸ æª¢æŸ¥å»£å‘Šæ””æˆªå™¨</button>
    <button onclick="testEmergencyFix()">ğŸš¨ æ¸¬è©¦ç·Šæ€¥ä¿®å¾©</button>
    <button onclick="checkDeploymentVersion()">ğŸ“¦ æª¢æŸ¥éƒ¨ç½²ç‰ˆæœ¬</button>

    <div id="results"></div>

    <script>
        let diagnosticResults = [];

        function logResult(type, message, details = null) {
            const timestamp = new Date().toLocaleTimeString();
            diagnosticResults.push({ type, message, details, timestamp });
            updateResultsDisplay();
        }

        function updateResultsDisplay() {
            const resultsDiv = document.getElementById('results');
            let html = '<div class="console-output"><strong>è¨ºæ–·çµæœï¼š</strong><br><br>';
            
            diagnosticResults.forEach(result => {
                const className = result.type === 'error' ? 'error-item' : 
                                result.type === 'success' ? 'success-item' : 'warning-item';
                html += `<div class="${className}">[${result.timestamp}] ${result.message}`;
                if (result.details) {
                    html += `<br>è©³ç´°: ${result.details}`;
                }
                html += '</div>';
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        async function runFullDiagnosis() {
            diagnosticResults = [];
            logResult('info', 'ğŸš€ é–‹å§‹å®Œæ•´è¨ºæ–·...');

            // 1. æª¢æŸ¥é é¢é¡å‹
            await checkPageType();
            
            // 2. æª¢æŸ¥ TechnicalIndicators çµ„ä»¶
            await checkTechnicalIndicatorsComponent();
            
            // 3. æ¸¬è©¦ç¶²è·¯è«‹æ±‚
            await testNetworkRequests();
            
            // 4. æª¢æŸ¥ç·Šæ€¥ä¿®å¾©
            await testEmergencyFix();
            
            // 5. æª¢æŸ¥éƒ¨ç½²ç‰ˆæœ¬
            await checkDeploymentVersion();
            
            logResult('success', 'âœ… è¨ºæ–·å®Œæˆï¼è«‹æŸ¥çœ‹ä¸Šæ–¹çµæœã€‚');
        }

        async function checkPageType() {
            const currentUrl = window.location.href;
            const isStockDetail = currentUrl.includes('/stock-overview/symbols/');
            const isStockOverview = currentUrl.includes('/stock-overview') && !currentUrl.includes('/symbols/');
            
            if (isStockDetail) {
                const symbol = currentUrl.split('/symbols/')[1]?.split(/[?#]/)[0];
                logResult('success', `âœ… æ­£ç¢ºé é¢é¡å‹: Stock Detail (${symbol})`);
            } else if (isStockOverview) {
                logResult('error', 'âŒ éŒ¯èª¤é é¢é¡å‹: Stock Overview (æ²’æœ‰ TechnicalIndicators çµ„ä»¶)', 
                    'è«‹å°èˆªåˆ° Stock Detail é é¢: /#/stock-overview/symbols/NVDA');
            } else {
                logResult('warning', 'âš ï¸ æœªçŸ¥é é¢é¡å‹', `ç•¶å‰ URL: ${currentUrl}`);
            }
        }

        async function checkTechnicalIndicatorsComponent() {
            const techIndicators = document.querySelector('.technical-indicators');
            
            if (techIndicators) {
                logResult('success', 'âœ… æ‰¾åˆ° TechnicalIndicators çµ„ä»¶');
                
                // æª¢æŸ¥ Build Stamp
                const buildStamp = document.querySelector('.technical-indicators h4')?.textContent;
                if (buildStamp && buildStamp.includes('BUILD-2026-01-03-01')) {
                    logResult('success', 'âœ… Build Stamp æ­£ç¢º', buildStamp);
                } else {
                    logResult('error', 'âŒ Build Stamp ä¸æ­£ç¢ºæˆ–ç¼ºå¤±', buildStamp || 'æœªæ‰¾åˆ°');
                }
                
                // æª¢æŸ¥æŒ‡æ¨™æ•¸é‡
                const indicators = document.querySelectorAll('.indicator-item');
                logResult('info', `ğŸ“Š æŒ‡æ¨™æ•¸é‡: ${indicators.length} (é æœŸ: 19)`);
                
                // æª¢æŸ¥ Debug å€å¡Š
                const debugBlock = document.querySelector('[style*="color: #856404"]');
                if (debugBlock) {
                    const debugText = debugBlock.textContent;
                    if (debugText.includes('yfKeys:') && !debugText.includes('yfKeys: none')) {
                        logResult('success', 'âœ… YFinance Debug å€å¡Šæ­£å¸¸', debugText.substring(0, 100) + '...');
                    } else {
                        logResult('error', 'âŒ YFinance Debug é¡¯ç¤º "none"', debugText);
                    }
                } else {
                    logResult('error', 'âŒ æœªæ‰¾åˆ° Debug å€å¡Š');
                }
                
            } else {
                logResult('error', 'âŒ æœªæ‰¾åˆ° TechnicalIndicators çµ„ä»¶', 'è«‹ç¢ºèªåœ¨æ­£ç¢ºçš„ Stock Detail é é¢');
            }
        }

        async function testNetworkRequests() {
            logResult('info', 'ğŸŒ æ¸¬è©¦ç¶²è·¯è«‹æ±‚...');
            
            try {
                // æ¸¬è©¦åŸºæœ¬é€£ç·š
                const baseUrl = window.location.origin + window.location.pathname;
                logResult('info', `åŸºç¤ URL: ${baseUrl}`);
                
                // æ¸¬è©¦ latest_index.json
                const indexUrl = `${baseUrl}data/technical-indicators/latest_index.json`;
                try {
                    const indexResponse = await fetch(indexUrl);
                    if (indexResponse.ok) {
                        const indexData = await indexResponse.json();
                        logResult('success', 'âœ… latest_index.json è¼‰å…¥æˆåŠŸ', 
                            `${indexData.symbols?.length || 0} å€‹è‚¡ç¥¨, æ—¥æœŸ: ${indexData.date || 'unknown'}`);
                        
                        // æ¸¬è©¦å–®ä¸€è‚¡ç¥¨è³‡æ–™
                        if (indexData.symbols && indexData.symbols.length > 0) {
                            const testSymbol = indexData.symbols[0];
                            const dataUrl = `${baseUrl}data/technical-indicators/${indexData.date}_${testSymbol}.json`;
                            
                            try {
                                const dataResponse = await fetch(dataUrl);
                                if (dataResponse.ok) {
                                    const stockData = await dataResponse.json();
                                    const hasYF = !!(stockData.indicators && stockData.indicators.yf);
                                    const yfKeys = hasYF ? Object.keys(stockData.indicators.yf) : [];
                                    
                                    if (hasYF && yfKeys.length >= 6) {
                                        logResult('success', `âœ… ${testSymbol} YFinance è³‡æ–™æ­£å¸¸`, 
                                            `${yfKeys.length} å€‹ YF æŒ‡æ¨™: ${yfKeys.join(', ')}`);
                                    } else {
                                        logResult('error', `âŒ ${testSymbol} YFinance è³‡æ–™ç¼ºå¤±`, 
                                            `YF æŒ‡æ¨™: ${yfKeys.length} å€‹`);
                                    }
                                } else {
                                    logResult('error', `âŒ ç„¡æ³•è¼‰å…¥ ${testSymbol} è³‡æ–™`, `HTTP ${dataResponse.status}`);
                                }
                            } catch (error) {
                                logResult('error', `âŒ ${testSymbol} è³‡æ–™è«‹æ±‚å¤±æ•—`, error.message);
                            }
                        }
                        
                    } else {
                        logResult('error', 'âŒ latest_index.json è¼‰å…¥å¤±æ•—', `HTTP ${indexResponse.status}`);
                    }
                } catch (error) {
                    logResult('error', 'âŒ latest_index.json è«‹æ±‚å¤±æ•—', error.message);
                }
                
            } catch (error) {
                logResult('error', 'âŒ ç¶²è·¯æ¸¬è©¦å¤±æ•—', error.message);
            }
        }

        async function checkAdBlocker() {
            logResult('info', 'ğŸ›¡ï¸ æª¢æŸ¥å»£å‘Šæ””æˆªå™¨...');
            
            // æª¢æŸ¥å¸¸è¦‹çš„å»£å‘Šæ””æˆªå™¨æ¨™èªŒ
            const adBlockerTests = [
                () => window.uBlock !== undefined,
                () => window.adblockDetector !== undefined,
                () => document.querySelector('#adblock-detected') !== null,
                () => {
                    // æ¸¬è©¦æ˜¯å¦æœ‰è«‹æ±‚è¢«é˜»æ“‹
                    const testImg = new Image();
                    testImg.src = 'https://googleads.g.doubleclick.net/pagead/id';
                    return false; // é€™å€‹æ¸¬è©¦éœ€è¦æ™‚é–“
                }
            ];
            
            let adBlockerDetected = false;
            adBlockerTests.forEach((test, index) => {
                try {
                    if (test()) {
                        adBlockerDetected = true;
                    }
                } catch (e) {
                    // å¿½ç•¥æ¸¬è©¦éŒ¯èª¤
                }
            });
            
            if (adBlockerDetected) {
                logResult('warning', 'âš ï¸ åµæ¸¬åˆ°å»£å‘Šæ””æˆªå™¨', 'å¯èƒ½é˜»æ“‹ API è«‹æ±‚ï¼Œè«‹å˜—è©¦æš«æ™‚åœç”¨');
            } else {
                logResult('info', 'â„¹ï¸ æœªåµæ¸¬åˆ°æ˜é¡¯çš„å»£å‘Šæ””æˆªå™¨');
            }
            
            // æª¢æŸ¥ Console ä¸­çš„ ERR_BLOCKED_BY_CLIENT éŒ¯èª¤
            logResult('info', 'è«‹æª¢æŸ¥ Console æ˜¯å¦æœ‰ "net::ERR_BLOCKED_BY_CLIENT" éŒ¯èª¤');
            logResult('info', 'å¦‚æœ‰æ­¤éŒ¯èª¤ï¼Œè«‹æš«æ™‚åœç”¨å»£å‘Šæ””æˆªå™¨æˆ–å°‡ç¶²ç«™åŠ å…¥ç™½åå–®');
        }

        async function testEmergencyFix() {
            logResult('info', 'ğŸš¨ æ¸¬è©¦ç·Šæ€¥ä¿®å¾©...');
            
            // æª¢æŸ¥ Console ä¸­çš„ç·Šæ€¥ä¿®å¾©æ—¥èªŒ
            const expectedLogs = [
                'BUILD_STAMP=2026-01-03_yf_fix_01',
                'ğŸš¨ Vue component mounted - starting emergency YFinance fix',
                'âœ… Emergency YFinance data created in mounted()',
                'EMERGENCY FIX: Using test data directly'
            ];
            
            logResult('info', 'è«‹æª¢æŸ¥ Console æ˜¯å¦åŒ…å«ä»¥ä¸‹ç·Šæ€¥ä¿®å¾©æ—¥èªŒï¼š');
            expectedLogs.forEach(log => {
                logResult('info', `- ${log}`);
            });
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æ¸¬è©¦è³‡æ–™
            const debugBlock = document.querySelector('[style*="color: #856404"]');
            if (debugBlock && debugBlock.textContent.includes('volume_last_day')) {
                logResult('success', 'âœ… ç·Šæ€¥ä¿®å¾©çš„æ¸¬è©¦è³‡æ–™å·²è¼‰å…¥');
            } else {
                logResult('error', 'âŒ ç·Šæ€¥ä¿®å¾©çš„æ¸¬è©¦è³‡æ–™æœªè¼‰å…¥');
            }
        }

        async function checkDeploymentVersion() {
            logResult('info', 'ğŸ“¦ æª¢æŸ¥éƒ¨ç½²ç‰ˆæœ¬...');
            
            try {
                // å˜—è©¦æª¢æŸ¥ JavaScript bundle ä¸­çš„ BUILD_STAMP
                const scripts = document.querySelectorAll('script[src]');
                let foundBuildStamp = false;
                
                for (const script of scripts) {
                    if (script.src.includes('assets/index') && script.src.includes('.js')) {
                        try {
                            const response = await fetch(script.src);
                            const content = await response.text();
                            
                            if (content.includes('BUILD_STAMP=2026-01-03_yf_fix_01')) {
                                logResult('success', 'âœ… æ‰¾åˆ°æ­£ç¢ºçš„ BUILD_STAMP', script.src);
                                foundBuildStamp = true;
                            }
                            
                            if (content.includes('EMERGENCY FIX')) {
                                logResult('success', 'âœ… æ‰¾åˆ°ç·Šæ€¥ä¿®å¾©ä»£ç¢¼');
                            }
                            
                            break;
                        } catch (error) {
                            logResult('warning', 'âš ï¸ ç„¡æ³•æª¢æŸ¥ JavaScript bundle', error.message);
                        }
                    }
                }
                
                if (!foundBuildStamp) {
                    logResult('error', 'âŒ æœªæ‰¾åˆ°æ­£ç¢ºçš„ BUILD_STAMP', 'å¯èƒ½æ˜¯å¿«å–å•é¡Œæˆ–éƒ¨ç½²æœªå®Œæˆ');
                }
                
            } catch (error) {
                logResult('error', 'âŒ ç‰ˆæœ¬æª¢æŸ¥å¤±æ•—', error.message);
            }
        }

        // è‡ªå‹•é–‹å§‹è¨ºæ–·
        setTimeout(() => {
            logResult('info', 'ğŸ” è‡ªå‹•è¨ºæ–·å·²å•Ÿå‹•ï¼Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•é€²è¡Œè©³ç´°æ¸¬è©¦');
        }, 1000);
    </script>
</body>
</html>