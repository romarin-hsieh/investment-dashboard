{"version":3,"file":"dataVersionService-DdooCtXs.js","sources":["../../src/utils/dataVersionService.js"],"sourcesContent":["/**\r\n * Data Version Service\r\n * \r\n * å¯¦æ–½åŸºæ–¼æ™‚é–“æˆ³çš„ç‰ˆæœ¬é©…å‹•æ•¸æ“šæ›´æ–°æª¢æŸ¥\r\n * å–ä»£å›ºå®šæ™‚é–“çª—å£çš„æ›´æ–°é‚è¼¯\r\n */\r\n\r\nimport { paths } from './baseUrl.js';\r\n\r\nclass DataVersionService {\r\n  constructor() {\r\n    this.STORAGE_KEY = 'lastSeenDataVersion';\r\n    this.isChecking = false;\r\n    this.listeners = new Set();\r\n  }\r\n\r\n  /**\r\n   * æª¢æŸ¥æ•¸æ“šç‰ˆæœ¬ä¸¦åœ¨éœ€è¦æ™‚åˆ·æ–°\r\n   * @returns {Promise<boolean>} æ˜¯å¦è§¸ç™¼äº†åˆ·æ–°\r\n   */\r\n  async checkDataVersionAndRefresh() {\r\n    if (this.isChecking) {\r\n      console.log('ğŸ”„ Version check already in progress');\r\n      return false;\r\n    }\r\n\r\n    this.isChecking = true;\r\n\r\n    try {\r\n      console.log('ğŸ” Checking data version...');\r\n\r\n      // 1. å¼·åˆ¶ no-cache è®€å– status.json\r\n      const statusUrl = paths.status() + '?v=' + Date.now();\r\n      const response = await fetch(statusUrl, {\r\n        cache: 'no-cache',\r\n        headers: {\r\n          'Cache-Control': 'no-cache, no-store, must-revalidate',\r\n          'Pragma': 'no-cache'\r\n        }\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Status fetch failed: ${response.status}`);\r\n      }\r\n\r\n      const status = await response.json();\r\n      \r\n      // 2. æ¯”è¼ƒç‰ˆæœ¬ - ä½¿ç”¨ generatedAt ä½œç‚ºç‰ˆæœ¬æ¨™è­˜\r\n      const currentVersion = status.generated || status.generatedAt;\r\n      const lastSeenVersion = localStorage.getItem(this.STORAGE_KEY);\r\n\r\n      console.log('ğŸ“Š Version check:', {\r\n        current: currentVersion,\r\n        lastSeen: lastSeenVersion,\r\n        changed: currentVersion !== lastSeenVersion\r\n      });\r\n\r\n      if (currentVersion !== lastSeenVersion) {\r\n        console.log('ğŸ”„ Data version changed - triggering refresh');\r\n        \r\n        // 3. ç‰ˆæœ¬è®Šæ›´ - æ¸…é™¤ç›¸é—œå¿«å–\r\n        await this.clearRelevantCaches();\r\n        \r\n        // 4. æ›´æ–°æœ¬åœ°å­˜å„²\r\n        localStorage.setItem(this.STORAGE_KEY, currentVersion);\r\n        \r\n        // 5. é‡æ–°è®€å–ç´¢å¼•æ–‡ä»¶ (no-cache)\r\n        await this.refreshIndexFiles(currentVersion);\r\n        \r\n        // 6. é€šçŸ¥ç›£è½å™¨\r\n        this.notifyListeners('versionChanged', {\r\n          oldVersion: lastSeenVersion,\r\n          newVersion: currentVersion,\r\n          status: status\r\n        });\r\n        \r\n        // 7. è§¸ç™¼é é¢åˆ·æ–° (å¯é¸æ“‡è»Ÿåˆ·æ–°æˆ–ç¡¬åˆ·æ–°)\r\n        this.triggerRefresh();\r\n        \r\n        return true;\r\n      } else {\r\n        console.log('âœ… Data version unchanged - no refresh needed');\r\n        return false;\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error('âŒ Version check failed:', error);\r\n      \r\n      // éŒ¯èª¤è™•ç† - ä¸é˜»æ­¢æ‡‰ç”¨é‹è¡Œ\r\n      this.notifyListeners('versionCheckError', { error });\r\n      return false;\r\n      \r\n    } finally {\r\n      this.isChecking = false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * æ¸…é™¤ç›¸é—œå¿«å–\r\n   */\r\n  async clearRelevantCaches() {\r\n    console.log('ğŸ—‘ï¸ Clearing relevant caches...');\r\n    \r\n    try {\r\n      // æ¸…é™¤ localStorage ä¸­çš„æ•¸æ“šå¿«å–\r\n      const keysToRemove = [];\r\n      for (let i = 0; i < localStorage.length; i++) {\r\n        const key = localStorage.key(i);\r\n        if (key && this.shouldClearCacheKey(key)) {\r\n          keysToRemove.push(key);\r\n        }\r\n      }\r\n      \r\n      keysToRemove.forEach(key => {\r\n        localStorage.removeItem(key);\r\n        console.log(`ğŸ—‘ï¸ Cleared cache key: ${key}`);\r\n      });\r\n      \r\n      // æ¸…é™¤ sessionStorage ä¸­çš„ç›¸é—œå¿«å–\r\n      const sessionKeysToRemove = [];\r\n      for (let i = 0; i < sessionStorage.length; i++) {\r\n        const key = sessionStorage.key(i);\r\n        if (key && this.shouldClearCacheKey(key)) {\r\n          sessionKeysToRemove.push(key);\r\n        }\r\n      }\r\n      \r\n      sessionKeysToRemove.forEach(key => {\r\n        sessionStorage.removeItem(key);\r\n        console.log(`ğŸ—‘ï¸ Cleared session cache key: ${key}`);\r\n      });\r\n      \r\n      console.log(`âœ… Cleared ${keysToRemove.length + sessionKeysToRemove.length} cache entries`);\r\n      \r\n    } catch (error) {\r\n      console.error('âŒ Cache clearing failed:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * åˆ¤æ–·æ˜¯å¦æ‡‰è©²æ¸…é™¤æŸå€‹å¿«å–éµ\r\n   * @param {string} key - å¿«å–éµ\r\n   * @returns {boolean} æ˜¯å¦æ‡‰è©²æ¸…é™¤\r\n   */\r\n  shouldClearCacheKey(key) {\r\n    const cachePatterns = [\r\n      'technical_indicators_',\r\n      'precomputed_',\r\n      'ohlcv_',\r\n      'latest_index_',\r\n      'status_',\r\n      'metadata_',\r\n      'TECHNICAL_INDICATORS',\r\n      'OHLCV_DATA',\r\n      'hybrid_technical_'\r\n    ];\r\n    \r\n    return cachePatterns.some(pattern => key.includes(pattern));\r\n  }\r\n\r\n  /**\r\n   * é‡æ–°è®€å–ç´¢å¼•æ–‡ä»¶\r\n   * @param {string} version - ç•¶å‰ç‰ˆæœ¬\r\n   */\r\n  async refreshIndexFiles(version) {\r\n    console.log('ğŸ”„ Refreshing index files...');\r\n    \r\n    try {\r\n      // é‡æ–°è®€å–æŠ€è¡“æŒ‡æ¨™ç´¢å¼•\r\n      const techIndexUrl = paths.technicalIndicatorsIndex() + '?v=' + version;\r\n      const techResponse = await fetch(techIndexUrl, {\r\n        cache: 'no-cache',\r\n        headers: {\r\n          'Cache-Control': 'no-cache, no-store, must-revalidate'\r\n        }\r\n      });\r\n      \r\n      if (techResponse.ok) {\r\n        const techIndex = await techResponse.json();\r\n        console.log('âœ… Technical indicators index refreshed:', techIndex.date);\r\n      }\r\n      \r\n      // é‡æ–°è®€å– OHLCV ç´¢å¼•\r\n      const ohlcvIndexUrl = paths.ohlcvIndex() + '?v=' + version;\r\n      const ohlcvResponse = await fetch(ohlcvIndexUrl, {\r\n        cache: 'no-cache',\r\n        headers: {\r\n          'Cache-Control': 'no-cache, no-store, must-revalidate'\r\n        }\r\n      });\r\n      \r\n      if (ohlcvResponse.ok) {\r\n        const ohlcvIndex = await ohlcvResponse.json();\r\n        console.log('âœ… OHLCV index refreshed:', ohlcvIndex.symbols?.length, 'symbols');\r\n      }\r\n      \r\n    } catch (error) {\r\n      console.error('âŒ Index refresh failed:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * è§¸ç™¼é é¢åˆ·æ–°\r\n   */\r\n  triggerRefresh() {\r\n    console.log('ğŸ”„ Triggering page refresh...');\r\n    \r\n    // å¯ä»¥é¸æ“‡è»Ÿåˆ·æ–°æˆ–ç¡¬åˆ·æ–°\r\n    const refreshMethod = this.getRefreshMethod();\r\n    \r\n    if (refreshMethod === 'hard') {\r\n      // ç¡¬åˆ·æ–° - é‡æ–°è¼‰å…¥æ•´å€‹é é¢\r\n      window.location.reload();\r\n    } else {\r\n      // è»Ÿåˆ·æ–° - é€šçŸ¥æ‡‰ç”¨é‡æ–°è¼‰å…¥æ•¸æ“š\r\n      this.notifyListeners('softRefresh');\r\n      \r\n      // å¦‚æœæ²’æœ‰ç›£è½å™¨è™•ç†è»Ÿåˆ·æ–°ï¼Œå‰‡å›é€€åˆ°ç¡¬åˆ·æ–°\r\n      setTimeout(() => {\r\n        if (this.listeners.size === 0) {\r\n          console.log('ğŸ”„ No soft refresh handlers, falling back to hard refresh');\r\n          window.location.reload();\r\n        }\r\n      }, 1000);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ç²å–åˆ·æ–°æ–¹æ³•\r\n   * @returns {string} 'soft' æˆ– 'hard'\r\n   */\r\n  getRefreshMethod() {\r\n    // å¯ä»¥æ ¹æ“šé…ç½®æˆ–ç’°å¢ƒæ±ºå®šåˆ·æ–°æ–¹æ³•\r\n    return 'hard'; // ç›®å‰ä½¿ç”¨ç¡¬åˆ·æ–°ï¼Œæœ€å¯é \r\n  }\r\n\r\n  /**\r\n   * æ·»åŠ äº‹ä»¶ç›£è½å™¨\r\n   * @param {Function} listener - ç›£è½å™¨å‡½æ•¸\r\n   */\r\n  addListener(listener) {\r\n    this.listeners.add(listener);\r\n  }\r\n\r\n  /**\r\n   * ç§»é™¤äº‹ä»¶ç›£è½å™¨\r\n   * @param {Function} listener - ç›£è½å™¨å‡½æ•¸\r\n   */\r\n  removeListener(listener) {\r\n    this.listeners.delete(listener);\r\n  }\r\n\r\n  /**\r\n   * é€šçŸ¥æ‰€æœ‰ç›£è½å™¨\r\n   * @param {string} event - äº‹ä»¶é¡å‹\r\n   * @param {Object} data - äº‹ä»¶æ•¸æ“š\r\n   */\r\n  notifyListeners(event, data = {}) {\r\n    this.listeners.forEach(listener => {\r\n      try {\r\n        listener(event, data);\r\n      } catch (error) {\r\n        console.error('âŒ Listener error:', error);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * ç²å–ç•¶å‰ç‰ˆæœ¬\r\n   * @returns {string|null} ç•¶å‰ç‰ˆæœ¬\r\n   */\r\n  getCurrentVersion() {\r\n    return localStorage.getItem(this.STORAGE_KEY);\r\n  }\r\n\r\n  /**\r\n   * æ‰‹å‹•è§¸ç™¼ç‰ˆæœ¬æª¢æŸ¥\r\n   * @returns {Promise<boolean>} æ˜¯å¦è§¸ç™¼äº†åˆ·æ–°\r\n   */\r\n  async forceVersionCheck() {\r\n    console.log('ğŸ”„ Force version check triggered');\r\n    return await this.checkDataVersionAndRefresh();\r\n  }\r\n\r\n  /**\r\n   * é‡ç½®ç‰ˆæœ¬æª¢æŸ¥ (æ¸…é™¤æœ¬åœ°ç‰ˆæœ¬è¨˜éŒ„)\r\n   */\r\n  resetVersionCheck() {\r\n    localStorage.removeItem(this.STORAGE_KEY);\r\n    console.log('ğŸ”„ Version check reset');\r\n  }\r\n\r\n  /**\r\n   * ç²å–ç‰ˆæœ¬æª¢æŸ¥ç‹€æ…‹\r\n   * @returns {Object} ç‹€æ…‹è³‡è¨Š\r\n   */\r\n  getStatus() {\r\n    return {\r\n      isChecking: this.isChecking,\r\n      currentVersion: this.getCurrentVersion(),\r\n      listenerCount: this.listeners.size,\r\n      storageKey: this.STORAGE_KEY\r\n    };\r\n  }\r\n}\r\n\r\n// å‰µå»ºå–®ä¾‹\r\nexport const dataVersionService = new DataVersionService();\r\n\r\n// è‡ªå‹•å•Ÿå‹•ç‰ˆæœ¬æª¢æŸ¥ (åœ¨é é¢è¼‰å…¥å¾Œ)\r\nif (typeof window !== 'undefined') {\r\n  // å»¶é²å•Ÿå‹•ï¼Œé¿å…å½±éŸ¿åˆå§‹é é¢è¼‰å…¥\r\n  setTimeout(() => {\r\n    dataVersionService.checkDataVersionAndRefresh();\r\n  }, 2000); // 2 ç§’å¾Œæª¢æŸ¥\r\n  \r\n  // ç›£è½é é¢å¯è¦‹æ€§è®ŠåŒ–ï¼Œç•¶é é¢é‡æ–°å¯è¦‹æ™‚æª¢æŸ¥ç‰ˆæœ¬\r\n  document.addEventListener('visibilitychange', () => {\r\n    if (!document.hidden) {\r\n      setTimeout(() => {\r\n        dataVersionService.checkDataVersionAndRefresh();\r\n      }, 1000);\r\n    }\r\n  });\r\n}\r\n\r\nexport default dataVersionService;"],"names":["DataVersionService","statusUrl","paths","response","status","currentVersion","lastSeenVersion","error","keysToRemove","i","key","sessionKeysToRemove","pattern","version","techIndexUrl","techResponse","techIndex","ohlcvIndexUrl","ohlcvResponse","ohlcvIndex","_a","listener","event","data","dataVersionService"],"mappings":"iGASA,MAAMA,CAAmB,CACvB,aAAc,CACZ,KAAK,YAAc,sBACnB,KAAK,WAAa,GAClB,KAAK,UAAY,IAAI,GACvB,CAMA,MAAM,4BAA6B,CACjC,GAAI,KAAK,WACP,eAAQ,IAAI,sCAAsC,EAC3C,GAGT,KAAK,WAAa,GAElB,GAAI,CACF,QAAQ,IAAI,6BAA6B,EAGzC,MAAMC,EAAYC,EAAM,OAAM,EAAK,MAAQ,KAAK,MAC1CC,EAAW,MAAM,MAAMF,EAAW,CACtC,MAAO,WACP,QAAS,CACP,gBAAiB,sCACjB,OAAU,UACpB,CACA,CAAO,EAED,GAAI,CAACE,EAAS,GACZ,MAAM,IAAI,MAAM,wBAAwBA,EAAS,MAAM,EAAE,EAG3D,MAAMC,EAAS,MAAMD,EAAS,OAGxBE,EAAiBD,EAAO,WAAaA,EAAO,YAC5CE,EAAkB,aAAa,QAAQ,KAAK,WAAW,EAQ7D,OANA,QAAQ,IAAI,oBAAqB,CAC/B,QAASD,EACT,SAAUC,EACV,QAASD,IAAmBC,CACpC,CAAO,EAEGD,IAAmBC,GACrB,QAAQ,IAAI,8CAA8C,EAG1D,MAAM,KAAK,sBAGX,aAAa,QAAQ,KAAK,YAAaD,CAAc,EAGrD,MAAM,KAAK,kBAAkBA,CAAc,EAG3C,KAAK,gBAAgB,iBAAkB,CACrC,WAAYC,EACZ,WAAYD,EACZ,OAAQD,CAClB,CAAS,EAGD,KAAK,eAAc,EAEZ,KAEP,QAAQ,IAAI,8CAA8C,EACnD,GAGX,OAASG,EAAO,CACd,eAAQ,MAAM,0BAA2BA,CAAK,EAG9C,KAAK,gBAAgB,oBAAqB,CAAE,MAAAA,CAAK,CAAE,EAC5C,EAET,QAAC,CACC,KAAK,WAAa,EACpB,CACF,CAKA,MAAM,qBAAsB,CAC1B,QAAQ,IAAI,iCAAiC,EAE7C,GAAI,CAEF,MAAMC,EAAe,CAAA,EACrB,QAASC,EAAI,EAAGA,EAAI,aAAa,OAAQA,IAAK,CAC5C,MAAMC,EAAM,aAAa,IAAID,CAAC,EAC1BC,GAAO,KAAK,oBAAoBA,CAAG,GACrCF,EAAa,KAAKE,CAAG,CAEzB,CAEAF,EAAa,QAAQE,GAAO,CAC1B,aAAa,WAAWA,CAAG,EAC3B,QAAQ,IAAI,0BAA0BA,CAAG,EAAE,CAC7C,CAAC,EAGD,MAAMC,EAAsB,CAAA,EAC5B,QAASF,EAAI,EAAGA,EAAI,eAAe,OAAQA,IAAK,CAC9C,MAAMC,EAAM,eAAe,IAAID,CAAC,EAC5BC,GAAO,KAAK,oBAAoBA,CAAG,GACrCC,EAAoB,KAAKD,CAAG,CAEhC,CAEAC,EAAoB,QAAQD,GAAO,CACjC,eAAe,WAAWA,CAAG,EAC7B,QAAQ,IAAI,kCAAkCA,CAAG,EAAE,CACrD,CAAC,EAED,QAAQ,IAAI,aAAaF,EAAa,OAASG,EAAoB,MAAM,gBAAgB,CAE3F,OAASJ,EAAO,CACd,QAAQ,MAAM,2BAA4BA,CAAK,CACjD,CACF,CAOA,oBAAoBG,EAAK,CAavB,MAZsB,CACpB,wBACA,eACA,SACA,gBACA,UACA,YACA,uBACA,aACA,mBACN,EAEyB,KAAKE,GAAWF,EAAI,SAASE,CAAO,CAAC,CAC5D,CAMA,MAAM,kBAAkBC,EAAS,OAC/B,QAAQ,IAAI,8BAA8B,EAE1C,GAAI,CAEF,MAAMC,EAAeZ,EAAM,yBAAwB,EAAK,MAAQW,EAC1DE,EAAe,MAAM,MAAMD,EAAc,CAC7C,MAAO,WACP,QAAS,CACP,gBAAiB,qCAC3B,CACA,CAAO,EAED,GAAIC,EAAa,GAAI,CACnB,MAAMC,EAAY,MAAMD,EAAa,OACrC,QAAQ,IAAI,0CAA2CC,EAAU,IAAI,CACvE,CAGA,MAAMC,EAAgBf,EAAM,WAAU,EAAK,MAAQW,EAC7CK,EAAgB,MAAM,MAAMD,EAAe,CAC/C,MAAO,WACP,QAAS,CACP,gBAAiB,qCAC3B,CACA,CAAO,EAED,GAAIC,EAAc,GAAI,CACpB,MAAMC,EAAa,MAAMD,EAAc,OACvC,QAAQ,IAAI,4BAA4BE,EAAAD,EAAW,UAAX,YAAAC,EAAoB,OAAQ,SAAS,CAC/E,CAEF,OAASb,EAAO,CACd,QAAQ,MAAM,0BAA2BA,CAAK,CAChD,CACF,CAKA,gBAAiB,CACf,QAAQ,IAAI,+BAA+B,EAGrB,KAAK,qBAEL,OAEpB,OAAO,SAAS,UAGhB,KAAK,gBAAgB,aAAa,EAGlC,WAAW,IAAM,CACX,KAAK,UAAU,OAAS,IAC1B,QAAQ,IAAI,2DAA2D,EACvE,OAAO,SAAS,SAEpB,EAAG,GAAI,EAEX,CAMA,kBAAmB,CAEjB,MAAO,MACT,CAMA,YAAYc,EAAU,CACpB,KAAK,UAAU,IAAIA,CAAQ,CAC7B,CAMA,eAAeA,EAAU,CACvB,KAAK,UAAU,OAAOA,CAAQ,CAChC,CAOA,gBAAgBC,EAAOC,EAAO,GAAI,CAChC,KAAK,UAAU,QAAQF,GAAY,CACjC,GAAI,CACFA,EAASC,EAAOC,CAAI,CACtB,OAAShB,EAAO,CACd,QAAQ,MAAM,oBAAqBA,CAAK,CAC1C,CACF,CAAC,CACH,CAMA,mBAAoB,CAClB,OAAO,aAAa,QAAQ,KAAK,WAAW,CAC9C,CAMA,MAAM,mBAAoB,CACxB,eAAQ,IAAI,kCAAkC,EACvC,MAAM,KAAK,4BACpB,CAKA,mBAAoB,CAClB,aAAa,WAAW,KAAK,WAAW,EACxC,QAAQ,IAAI,wBAAwB,CACtC,CAMA,WAAY,CACV,MAAO,CACL,WAAY,KAAK,WACjB,eAAgB,KAAK,kBAAiB,EACtC,cAAe,KAAK,UAAU,KAC9B,WAAY,KAAK,WACvB,CACE,CACF,CAGY,MAACiB,EAAqB,IAAIxB,EAGlC,OAAO,OAAW,MAEpB,WAAW,IAAM,CACfwB,EAAmB,2BAA0B,CAC/C,EAAG,GAAI,EAGP,SAAS,iBAAiB,mBAAoB,IAAM,CAC7C,SAAS,QACZ,WAAW,IAAM,CACfA,EAAmB,2BAA0B,CAC/C,EAAG,GAAI,CAEX,CAAC"}