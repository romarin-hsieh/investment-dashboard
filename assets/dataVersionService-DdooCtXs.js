import{p as a}from"./index-s0ph0adL.js";import"./vendor-DopR3Z58.js";import"./utils-C6BRd-cb.js";class h{constructor(){this.STORAGE_KEY="lastSeenDataVersion",this.isChecking=!1,this.listeners=new Set}async checkDataVersionAndRefresh(){if(this.isChecking)return console.log("ğŸ”„ Version check already in progress"),!1;this.isChecking=!0;try{console.log("ğŸ” Checking data version...");const s=a.status()+"?v="+Date.now(),r=await fetch(s,{cache:"no-cache",headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache"}});if(!r.ok)throw new Error(`Status fetch failed: ${r.status}`);const e=await r.json(),t=e.generated||e.generatedAt,o=localStorage.getItem(this.STORAGE_KEY);return console.log("ğŸ“Š Version check:",{current:t,lastSeen:o,changed:t!==o}),t!==o?(console.log("ğŸ”„ Data version changed - triggering refresh"),await this.clearRelevantCaches(),localStorage.setItem(this.STORAGE_KEY,t),await this.refreshIndexFiles(t),this.notifyListeners("versionChanged",{oldVersion:o,newVersion:t,status:e}),this.triggerRefresh(),!0):(console.log("âœ… Data version unchanged - no refresh needed"),!1)}catch(s){return console.error("âŒ Version check failed:",s),this.notifyListeners("versionCheckError",{error:s}),!1}finally{this.isChecking=!1}}async clearRelevantCaches(){console.log("ğŸ—‘ï¸ Clearing relevant caches...");try{const s=[];for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);t&&this.shouldClearCacheKey(t)&&s.push(t)}s.forEach(e=>{localStorage.removeItem(e),console.log(`ğŸ—‘ï¸ Cleared cache key: ${e}`)});const r=[];for(let e=0;e<sessionStorage.length;e++){const t=sessionStorage.key(e);t&&this.shouldClearCacheKey(t)&&r.push(t)}r.forEach(e=>{sessionStorage.removeItem(e),console.log(`ğŸ—‘ï¸ Cleared session cache key: ${e}`)}),console.log(`âœ… Cleared ${s.length+r.length} cache entries`)}catch(s){console.error("âŒ Cache clearing failed:",s)}}shouldClearCacheKey(s){return["technical_indicators_","precomputed_","ohlcv_","latest_index_","status_","metadata_","TECHNICAL_INDICATORS","OHLCV_DATA","hybrid_technical_"].some(e=>s.includes(e))}async refreshIndexFiles(s){var r;console.log("ğŸ”„ Refreshing index files...");try{const e=a.technicalIndicatorsIndex()+"?v="+s,t=await fetch(e,{cache:"no-cache",headers:{"Cache-Control":"no-cache, no-store, must-revalidate"}});if(t.ok){const n=await t.json();console.log("âœ… Technical indicators index refreshed:",n.date)}const o=a.ohlcvIndex()+"?v="+s,c=await fetch(o,{cache:"no-cache",headers:{"Cache-Control":"no-cache, no-store, must-revalidate"}});if(c.ok){const n=await c.json();console.log("âœ… OHLCV index refreshed:",(r=n.symbols)==null?void 0:r.length,"symbols")}}catch(e){console.error("âŒ Index refresh failed:",e)}}triggerRefresh(){console.log("ğŸ”„ Triggering page refresh..."),this.getRefreshMethod()==="hard"?window.location.reload():(this.notifyListeners("softRefresh"),setTimeout(()=>{this.listeners.size===0&&(console.log("ğŸ”„ No soft refresh handlers, falling back to hard refresh"),window.location.reload())},1e3))}getRefreshMethod(){return"hard"}addListener(s){this.listeners.add(s)}removeListener(s){this.listeners.delete(s)}notifyListeners(s,r={}){this.listeners.forEach(e=>{try{e(s,r)}catch(t){console.error("âŒ Listener error:",t)}})}getCurrentVersion(){return localStorage.getItem(this.STORAGE_KEY)}async forceVersionCheck(){return console.log("ğŸ”„ Force version check triggered"),await this.checkDataVersionAndRefresh()}resetVersionCheck(){localStorage.removeItem(this.STORAGE_KEY),console.log("ğŸ”„ Version check reset")}getStatus(){return{isChecking:this.isChecking,currentVersion:this.getCurrentVersion(),listenerCount:this.listeners.size,storageKey:this.STORAGE_KEY}}}const i=new h;typeof window<"u"&&(setTimeout(()=>{i.checkDataVersionAndRefresh()},2e3),document.addEventListener("visibilitychange",()=>{document.hidden||setTimeout(()=>{i.checkDataVersionAndRefresh()},1e3)}));export{i as dataVersionService,i as default};
//# sourceMappingURL=dataVersionService-DdooCtXs.js.map
