name: Update Sector and Industry Data

on:
  # æ¯æ—¥ 0:20 UTC (8:20 å°ç£æ™‚é–“) åŸ·è¡Œ
  schedule:
    - cron: '20 0 * * *'
  
  # æ¯æ¬¡éƒ¨ç½²åˆ° main åˆ†æ”¯æ™‚åŸ·è¡Œ
  # æ¯æ¬¡éƒ¨ç½²åˆ° main åˆ†æ”¯æ™‚åŸ·è¡Œ
  # push:
  #   branches: [ main ]
  #   paths-ignore:
  #     - 'README.md'
  #     - 'docs/**'
  #     - '*.md'
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update all data'
        required: false
        default: false
        type: boolean

jobs:
  update-sector-industry:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        pip install yfinance pandas requests
    
    - name: Create Python script for data fetching
      run: |
        cat > fetch_sector_industry.py << 'EOF'
        import yfinance as yf
        import json
        import sys
        from datetime import datetime, timezone
        import time
        import os

        def get_stock_symbols():
            """å¾å¤šå€‹ä¾†æºç²å–è‚¡ç¥¨ä»£è™Ÿåˆ—è¡¨"""
            symbols = []
            
            # 1. å˜—è©¦å¾ universe.json è®€å–
            try:
                if os.path.exists('config/universe.json'):
                    with open('config/universe.json', 'r') as f:
                        data = json.load(f)
                        if 'symbols' in data and isinstance(data['symbols'], list):
                            symbols = data['symbols']
                            print(f"âœ… å¾ universe.json è¼‰å…¥ {len(symbols)} å€‹è‚¡ç¥¨ä»£è™Ÿ")
                            return symbols
            except Exception as e:
                print(f"âš ï¸ ç„¡æ³•å¾ universe.json è®€å–: {e}")
            
            # 2. å˜—è©¦å¾ç¾æœ‰çš„ symbols_metadata.json è®€å–
            try:
                if os.path.exists('public/data/symbols_metadata.json'):
                    with open('public/data/symbols_metadata.json', 'r') as f:
                        data = json.load(f)
                        if 'items' in data:
                            symbols = [item['symbol'] for item in data['items']]
                            print(f"âœ… å¾ symbols_metadata.json è¼‰å…¥ {len(symbols)} å€‹è‚¡ç¥¨ä»£è™Ÿ")
                            return symbols
            except Exception as e:
                print(f"âš ï¸ ç„¡æ³•å¾ symbols_metadata.json è®€å–: {e}")
            
            # 3. ä½¿ç”¨é è¨­çš„ 24 æ”¯è‚¡ç¥¨
            symbols = [
                'ASTS', 'RIVN', 'PL', 'ONDS', 'RDW', 
                'AVAV', 'MDB', 'ORCL', 'TSM', 'RKLB',
                'CRM', 'NVDA', 'AVGO', 'AMZN', 'GOOG',
                'META', 'NFLX', 'LEU', 'SMR', 'CRWV',
                'IONQ', 'PLTR', 'HIMS', 'TSLA'
            ]
            print(f"âœ… ä½¿ç”¨é è¨­çš„ {len(symbols)} å€‹è‚¡ç¥¨ä»£è™Ÿ")
            return symbols

        def categorize_market_cap(market_cap):
            """å¸‚å€¼åˆ†é¡"""
            if not market_cap or market_cap <= 0:
                return 'unknown'
            
            if market_cap >= 200_000_000_000:  # >= 200B
                return 'mega_cap'
            elif market_cap >= 10_000_000_000:  # >= 10B
                return 'large_cap'
            elif market_cap >= 2_000_000_000:   # >= 2B
                return 'mid_cap'
            elif market_cap >= 300_000_000:     # >= 300M
                return 'small_cap'
            else:
                return 'micro_cap'

        def get_default_exchange(symbol):
            """é è¨­ exchange é‚è¼¯"""
            nyse_symbols = ['CRM', 'TSM', 'ORCL', 'RDW', 'PL']
            return 'NYSE' if symbol in nyse_symbols else 'NASDAQ'

        def fetch_symbol_data(symbol):
            """ç²å–å–®å€‹è‚¡ç¥¨çš„è³‡æ–™"""
            try:
                print(f"ğŸ” æ­£åœ¨ç²å– {symbol} çš„è³‡æ–™...")
                
                # å‰µå»º Ticker ç‰©ä»¶
                ticker = yf.Ticker(symbol)
                
                # ç²å–è³‡è¨Š
                info = ticker.info
                
                if not info or 'symbol' not in info:
                    raise Exception(f"ç„¡æ³•ç²å– {symbol} çš„åŸºæœ¬è³‡è¨Š")
                
                # æå–è³‡æ–™
                sector = info.get('sector', 'Unknown')
                industry = info.get('industry', 'Unknown Industry')
                market_cap = info.get('marketCap', 0)
                exchange = info.get('exchange', get_default_exchange(symbol))
                country = info.get('country', 'US')
                website = info.get('website', '')
                employee_count = info.get('fullTimeEmployees', None)
                business_summary = info.get('longBusinessSummary', '')
                
                # å¦‚æœ sector æˆ– industry ç‚ºç©ºï¼Œå˜—è©¦å…¶ä»–æ¬„ä½
                if sector in ['Unknown', '', None]:
                    sector = info.get('sectorKey', 'Unknown')
                if industry in ['Unknown Industry', '', None]:
                    industry = info.get('industryKey', 'Unknown Industry')
                
                data = {
                    'symbol': symbol,
                    'sector': sector,
                    'industry': industry,
                    'confidence': 1.0,  # yfinance è³‡æ–™é«˜ä¿¡å¿ƒåº¦
                    'sources': ['yfinance_python'],
                    'last_verified_at': datetime.now(timezone.utc).isoformat(),
                    'market_cap_category': categorize_market_cap(market_cap),
                    'exchange': exchange,
                    'country': country,
                    'website': website,
                    'employee_count': employee_count,
                    'business_summary': business_summary[:500] if business_summary else '',  # é™åˆ¶é•·åº¦
                    'market_cap': market_cap,
                    'api_source': 'yfinance_python'
                }
                
                print(f"âœ… {symbol}: {sector} - {industry} ({exchange})")
                return data
                
            except Exception as e:
                print(f"âŒ {symbol} å¤±æ•—: {e}")
                
                # å›é€€è³‡æ–™
                fallback_data = {
                    'ASTS': {'sector': 'Communication Services', 'industry': 'Satellite Communications'},
                    'RIVN': {'sector': 'Consumer Cyclical', 'industry': 'Electric Vehicles'},
                    'PL': {'sector': 'Technology', 'industry': 'Satellite Imaging & Analytics'},
                    'ONDS': {'sector': 'Technology', 'industry': 'Industrial IoT Solutions'},
                    'RDW': {'sector': 'Industrials', 'industry': 'Space Infrastructure'},
                    'AVAV': {'sector': 'Industrials', 'industry': 'Aerospace & Defense'},
                    'MDB': {'sector': 'Technology', 'industry': 'Database Software'},
                    'ORCL': {'sector': 'Technology', 'industry': 'Enterprise Software'},
                    'TSM': {'sector': 'Technology', 'industry': 'Semiconductors'},
                    'RKLB': {'sector': 'Industrials', 'industry': 'Aerospace & Defense'},
                    'CRM': {'sector': 'Technology', 'industry': 'Enterprise Software'},
                    'NVDA': {'sector': 'Technology', 'industry': 'Semiconductors'},
                    'AVGO': {'sector': 'Technology', 'industry': 'Semiconductors'},
                    'AMZN': {'sector': 'Consumer Cyclical', 'industry': 'Internet Retail'},
                    'GOOG': {'sector': 'Communication Services', 'industry': 'Internet Content & Information'},
                    'META': {'sector': 'Communication Services', 'industry': 'Internet Content & Information'},
                    'NFLX': {'sector': 'Communication Services', 'industry': 'Entertainment'},
                    'LEU': {'sector': 'Energy', 'industry': 'Uranium'},
                    'SMR': {'sector': 'Energy', 'industry': 'Nuclear Energy'},
                    'CRWV': {'sector': 'Technology', 'industry': 'Software - Application'},
                    'IONQ': {'sector': 'Technology', 'industry': 'Quantum Computing'},
                    'PLTR': {'sector': 'Technology', 'industry': 'Software - Infrastructure'},
                    'HIMS': {'sector': 'Healthcare', 'industry': 'Health Information Services'},
                    'TSLA': {'sector': 'Consumer Cyclical', 'industry': 'Auto Manufacturers'}
                }
                
                fallback = fallback_data.get(symbol, {'sector': 'Unknown', 'industry': 'Unknown Industry'})
                
                return {
                    'symbol': symbol,
                    'sector': fallback['sector'],
                    'industry': fallback['industry'],
                    'confidence': 0.8,  # å›é€€è³‡æ–™è¼ƒä½ä¿¡å¿ƒåº¦
                    'sources': ['fallback_data'],
                    'last_verified_at': datetime.now(timezone.utc).isoformat(),
                    'market_cap_category': 'unknown',
                    'exchange': get_default_exchange(symbol),
                    'country': 'US',
                    'website': '',
                    'employee_count': None,
                    'business_summary': '',
                    'market_cap': None,
                    'api_source': 'fallback'
                }

        def main():
            print("ğŸš€ é–‹å§‹ç²å– Sector å’Œ Industry è³‡æ–™...")
            
            # ç²å–è‚¡ç¥¨ä»£è™Ÿåˆ—è¡¨
            symbols = get_stock_symbols()
            
            if not symbols:
                print("âŒ ç„¡æ³•ç²å–è‚¡ç¥¨ä»£è™Ÿåˆ—è¡¨")
                sys.exit(1)
            
            print(f"ğŸ“Š å°‡è™•ç† {len(symbols)} å€‹è‚¡ç¥¨ä»£è™Ÿ: {', '.join(symbols)}")
            
            # ç²å–æ‰€æœ‰è‚¡ç¥¨è³‡æ–™
            results = []
            success_count = 0
            fallback_count = 0
            
            for i, symbol in enumerate(symbols, 1):
                print(f"\n[{i}/{len(symbols)}] è™•ç† {symbol}...")
                
                data = fetch_symbol_data(symbol)
                results.append(data)
                
                if data['api_source'] == 'yfinance_python':
                    success_count += 1
                else:
                    fallback_count += 1
                
                # å»¶é²é¿å… API é™åˆ¶
                if i < len(symbols):
                    time.sleep(1)
            
            # ç”Ÿæˆçµ±è¨ˆè³‡æ–™
            sector_grouping = {}
            confidence_distribution = {'high_confidence_1_0': 0, 'fallback_confidence_0_8': 0}
            
            for item in results:
                sector = item['sector']
                if sector not in sector_grouping:
                    sector_grouping[sector] = []
                sector_grouping[sector].append(item['symbol'])
                
                if item['confidence'] == 1.0:
                    confidence_distribution['high_confidence_1_0'] += 1
                else:
                    confidence_distribution['fallback_confidence_0_8'] += 1
            
            # å‰µå»ºæœ€çµ‚è³‡æ–™çµæ§‹
            final_data = {
                'ttl_days': 7,
                'as_of': datetime.now(timezone.utc).isoformat(),
                'next_refresh': datetime.now(timezone.utc).replace(hour=0, minute=20, second=0, microsecond=0).isoformat(),
                'items': results,
                'sector_grouping': sector_grouping,
                'confidence_distribution': confidence_distribution,
                'data_sources': {
                    'yfinance_python': success_count,
                    'fallback_data': fallback_count
                },
                'refresh_metadata': {
                    'symbols_updated': len(results),
                    'symbols_success': success_count,
                    'symbols_fallback': fallback_count,
                    'update_source': 'github_actions_python'
                }
            }
            
            # ç¢ºä¿ç›®éŒ„å­˜åœ¨
            os.makedirs('public/data', exist_ok=True)
            
            # å¯«å…¥æª”æ¡ˆ
            with open('public/data/sector_industry.json', 'w', encoding='utf-8') as f:
                json.dump(final_data, f, indent=2, ensure_ascii=False)
            
            print(f"\nâœ… è³‡æ–™æ›´æ–°å®Œæˆ!")
            print(f"ğŸ“Š ç¸½è¨ˆ: {len(results)} å€‹è‚¡ç¥¨")
            print(f"ğŸ¯ æˆåŠŸ: {success_count} å€‹ (YFinance API)")
            print(f"ğŸ”„ å›é€€: {fallback_count} å€‹ (Fallback Data)")
            print(f"ğŸ“ æª”æ¡ˆå·²å„²å­˜: public/data/sector_industry.json")
            
            # åŒæ™‚æ›´æ–° symbols_metadata.json ä»¥ä¿æŒç›¸å®¹æ€§
            with open('public/data/symbols_metadata.json', 'w', encoding='utf-8') as f:
                json.dump(final_data, f, indent=2, ensure_ascii=False)
            
            print(f"ğŸ“ ç›¸å®¹æ€§æª”æ¡ˆå·²æ›´æ–°: public/data/symbols_metadata.json")

        if __name__ == '__main__':
            main()
        EOF
    
    - name: Run Python script to fetch data
      run: |
        python fetch_sector_industry.py
    
    - name: Check for changes
      id: changes
      run: |
        if git diff --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "Changes detected:"
          git diff --name-only
        fi
    
    - name: Commit and push changes
      if: steps.changes.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ è®Šæ›´çš„æ–‡ä»¶
        git add public/data/sector_industry.json
        git add public/data/symbols_metadata.json
        
        # å‰µå»ºæäº¤è¨Šæ¯
        COMMIT_MSG="ğŸ¤– Auto-update sector and industry data - Updated via Python yfinance library"
        
        git commit -m "$COMMIT_MSG"
        
        # æ‹‰å–æœ€æ–°è®Šæ›´ä¸¦ Rebase (ä½¿ç”¨ -Xtheirs ç­–ç•¥è§£æ±ºè¡çªï¼šä¿ç•™æˆ‘å€‘å‰›ç”Ÿæˆçš„ç‰ˆæœ¬)
        echo "ğŸ”„ Pulling latest changes to avoid conflicts..."
        git fetch origin
        git pull origin main --rebase -Xtheirs || {
          echo "âš ï¸ Pull/Rebase failed even with strategy..."
          exit 1
        }
        
        # æ¨é€è®Šæ›´
        echo "ğŸš€ Pushing changes..."
        git push || {
          echo "âš ï¸ Push failed, retrying..."
          git pull origin main --rebase
          git push
        }
    
    - name: Create summary
      if: always()
      run: |
        echo "## ğŸ“Š Sector & Industry Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**Changes:** ${{ steps.changes.outputs.changed }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.changes.outputs.changed }}" == "true" ]; then
          echo "### ğŸ“ Files Updated:" >> $GITHUB_STEP_SUMMARY
          echo "- public/data/sector_industry.json" >> $GITHUB_STEP_SUMMARY
          echo "- public/data/symbols_metadata.json" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ Data Source:" >> $GITHUB_STEP_SUMMARY
          echo "- Python yfinance library (server-side, no CORS issues)" >> $GITHUB_STEP_SUMMARY
          echo "- Static JSON deployment to gh-pages" >> $GITHUB_STEP_SUMMARY
          echo "- Same-origin access from frontend" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âœ… No updates needed" >> $GITHUB_STEP_SUMMARY
          echo "All sector and industry data is up to date." >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "## âŒ Sector & Industry Update Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The sector and industry update process encountered an error." >> $GITHUB_STEP_SUMMARY
        echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY