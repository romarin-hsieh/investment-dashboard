name: Daily Data Update

on:
  schedule:
    # æ¯å¤© UTC 02:00 åŸ·è¡Œ (å°åŒ—æ™‚é–“ 10:00)
    - cron: '0 2 * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Node.js dependencies
      run: npm ci

    - name: Install GitHub CLI
      run: |
        sudo apt-get update
        sudo apt-get install gh

    - name: Install Python dependencies
      run: |
        pip install yfinance pandas numpy requests pytz

    - name: Create data directories
      run: |
        mkdir -p public/data/ohlcv
        mkdir -p public/data/technical-indicators
        mkdir -p public/data/quotes
        mkdir -p public/data/daily
        mkdir -p public/config

    - name: Sync Config Files (Root -> Public)
      run: |
        echo "ğŸ”„ Syncing config files..."
        cp config/stocks.json public/config/stocks.json
        cp config/universe.json public/config/universe.json || true
        echo "âœ… Config files synced to public/config/"

    # âœ… T2ï¼šç”¨çœŸå¯¦è¡Œæƒ…é‡ç”¢ precomputed OHLCVï¼ˆä¸ç¶“ CORSï¼‰
    - name: Generate REAL OHLCV data (yfinance, 2 formats + index.json)
      run: |
        echo "ğŸ”„ Generating REAL OHLCV data for all universe symbols (yfinance)..."
        python scripts/generate-real-ohlcv-yfinance.py --days 1825 --interval 1d --min-rows 24

    # âœ… é˜²å‘†ï¼šç¢ºä¿ index.json å« symbolsï¼ˆé¿å… precomputedOhlcvApi.getAvailableSymbols() çˆ†æ‰ï¼‰
    - name: Validate OHLCV index schema (must include symbols)
      run: |
        python - <<'PY'
        import json, sys
        p = "public/data/ohlcv/index.json"
        with open(p, "r", encoding="utf-8") as f:
          idx = json.load(f)
        if not isinstance(idx.get("symbols"), list) or len(idx["symbols"]) == 0:
          print("âŒ index.json missing symbols or empty symbols list")
          sys.exit(2)
        print(f"âœ… index.json OK. symbols={len(idx['symbols'])}, totalFiles={idx.get('totalFiles')}")
        PY

    - name: Generate Technical Indicators
      run: |
        echo "ğŸ”„ Generating technical indicators..."
        node scripts/generate-daily-technical-indicators.js



    - name: Cleanup old technical indicators (keep last 30 days)
      run: |
        echo "ğŸ§¹ Cleaning old technical indicator day-files..."
        node scripts/cleanup-old-technical-indicators.js --retention-days=30 --verbose

    - name: Update Metadata (weekly on Monday)
      if: github.event.schedule == '0 2 * * 1' || github.event_name == 'workflow_dispatch'
      run: |
        echo "ğŸ”„ Updating metadata (weekly)..."
        python scripts/update-metadata-python.py

    - name: Fetch Fundamentals Data (yahoo-finance2)
      run: |
        echo "ğŸ”„ Fetching fundamental data (including analyst insights)..."
        node scripts/fetch-fundamentals.js

    - name: Generate Quotes Snapshot
      run: |
        echo "ğŸ”„ Generating quotes snapshot (latest.json)..."
        node scripts/generate-quotes-snapshot.js

    - name: Generate Daily Snapshot
      run: |
        echo "ğŸ”„ Generating daily snapshot..."
        node scripts/generate-daily-snapshot.js

    - name: Generate Dashboard Status (Trend/Comet)
      run: |
        echo "ğŸ”„ Generating dashboard status (Trend Continuation)..."
        python scripts/production/daily_update.py

    - name: Update Market Sentiment (Fear & Greed)
      run: |
        echo "ğŸ”„ Updating Fear & Greed Index..."
        python scripts/update_sentiment.py

    - name: Update Status File
      run: |
        echo "ğŸ”„ Updating status file..."
        node scripts/update-status.js

    # âœ… æ›´å®‰å…¨çš„ commitï¼ˆåŒ…å«æ–°æª”ï¼‰
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add -A public/data public/config
        
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No changes to commit"
          exit 0
        fi
        
        git commit -m "ğŸ¤– Daily data update $(date -u +%Y-%m-%d)"
        
        # å˜—è©¦æ‹‰å–æœ€æ–°è®Šæ›´ä»¥é¿å…è¡çª
        git pull --rebase origin main || true
        git push
        echo "âœ… Data updated and pushed"

    - name: Summary
      run: |
        echo "ğŸ“Š Daily Data Update Summary:"
        echo "- OHLCV files: $(find public/data/ohlcv -name '*.json' | wc -l)"
        echo "- Technical indicators: $(find public/data/technical-indicators -name '*.json' | wc -l)"
        echo "- Retention policy: 30 days for technical indicators"
        echo "- Generated at: $(date -u)"