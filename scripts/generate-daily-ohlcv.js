#!/usr/bin/env node

/**
 * Daily OHLCV Data Generator
 * 
 * ç‚ºæ‰€æœ‰ universe symbols ç”Ÿæˆå…©ç¨®æ ¼å¼çš„ OHLCV æ•¸æ“šï¼š
 * 1. SYMBOL.json (çµ¦ ohlcvApi ç”¨)
 * 2. symbol_period_days.json (çµ¦ precomputedOhlcvApi ç”¨)
 * 3. index.json (çµ¦ precomputedOhlcvApi ç”¨)
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// é…ç½®
const CONFIG = {
  outputDir: path.join(__dirname, '../public/data/ohlcv'),
  universeFile: path.join(__dirname, '../config/universe.json'),
  periods: ['1d'],
  ranges: {
    '3mo': 90,
    '6mo': 180,
    '1y': 365
  },
  defaultRange: '3mo'
};

/**
 * è¼‰å…¥ universe é…ç½®
 */
function loadUniverse() {
  try {
    const data = fs.readFileSync(CONFIG.universeFile, 'utf8');
    const universe = JSON.parse(data);
    return universe.symbols || [];
  } catch (error) {
    console.error('âŒ Failed to load universe:', error);
    // å›é€€åˆ°åŸºæœ¬æ¸…å–®
    return [
      'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'META', 'NVDA', 'NFLX',
      'ASTS', 'RIVN', 'ONDS', 'AVAV', 'MDB', 'RKLB', 'AVGO', 'CRWV',
      'PLTR', 'ORCL', 'TSM', 'RDW', 'CRM', 'PL', 'LEU', 'SMR',
      'IONQ', 'HIMS', 'PANW', 'UUUU', 'UMAC'
    ];
  }
}

/**
 * ç”Ÿæˆæ¨¡æ“¬ OHLCV æ•¸æ“š
 */
function generateOhlcvData(symbol, days, basePrice = 100) {
  const data = {
    timestamps: [],
    open: [],
    high: [],
    low: [],
    close: [],
    volume: [],
    metadata: {
      symbol: symbol,
      period: '1d',
      days: days,
      generated: new Date().toISOString(),
      source: 'GitHub Actions Daily Update',
      note: 'Generated by daily-data-update workflow'
    }
  };

  let currentPrice = basePrice;
  const now = Date.now();
  const dayMs = 24 * 60 * 60 * 1000;

  for (let i = days - 1; i >= 0; i--) {
    const timestamp = now - (i * dayMs);
    
    // ç”Ÿæˆåƒ¹æ ¼è®Šå‹• (-3% åˆ° +3%)
    const priceChange = (Math.random() - 0.5) * 0.06;
    const open = currentPrice;
    const close = open * (1 + priceChange);
    
    // ç”Ÿæˆé«˜ä½åƒ¹
    const volatility = Math.random() * 0.02 + 0.005; // 0.5-2.5% æ³¢å‹•
    const high = Math.max(open, close) * (1 + volatility);
    const low = Math.min(open, close) * (1 - volatility);
    
    // ç”Ÿæˆæˆäº¤é‡ (500K - 5M)
    const baseVolume = 500000 + Math.random() * 4500000;
    const volume = Math.floor(baseVolume);
    
    data.timestamps.push(timestamp);
    data.open.push(parseFloat(open.toFixed(2)));
    data.high.push(parseFloat(high.toFixed(2)));
    data.low.push(parseFloat(low.toFixed(2)));
    data.close.push(parseFloat(close.toFixed(2)));
    data.volume.push(volume);
    
    currentPrice = close;
  }

  return data;
}

/**
 * ç²å–è‚¡ç¥¨åŸºç¤åƒ¹æ ¼
 */
function getBasePrice(symbol) {
  const priceMap = {
    'AAPL': 180, 'MSFT': 350, 'GOOGL': 140, 'AMZN': 150, 'TSLA': 250,
    'META': 280, 'NVDA': 450, 'NFLX': 400, 'ASTS': 25, 'RIVN': 15,
    'ONDS': 8, 'AVAV': 120, 'MDB': 280, 'RKLB': 12, 'AVGO': 850,
    'CRWV': 75, 'PLTR': 35, 'ORCL': 110, 'TSM': 95, 'RDW': 45,
    'CRM': 250, 'PL': 15, 'LEU': 80, 'SMR': 12, 'IONQ': 18,
    'HIMS': 20, 'PANW': 320, 'UUUU': 5, 'UMAC': 3, 'VST': 85,
    'KTOS': 25, 'MELI': 1200, 'SOFI': 8, 'RBRK': 45, 'EOSE': 12,
    'CEG': 180, 'TMDX': 35, 'GRAB': 4, 'RBLX': 45, 'IREN': 15,
    'OKLO': 8, 'PATH': 15, 'INTR': 25, 'SE': 85, 'KSPI': 12,
    'LUNR': 8, 'HOOD': 25, 'APP': 35, 'CHYM': 15, 'NU': 12,
    'COIN': 180, 'CRCL': 25, 'IBKR': 85, 'CCJ': 45, 'VRT': 35,
    'ETN': 280, 'ADBE': 450, 'FIG': 15, 'CRWD': 280, 'DDOG': 120,
    'DUOL': 180, 'ZETA': 25, 'AXON': 350, 'ALAB': 85, 'LRCX': 850,
    'BWXT': 120, 'MP': 25, 'RR': 8
  };
  
  return priceMap[symbol] || 100;
}

/**
 * ç”Ÿæˆæ‰€æœ‰ OHLCV æ•¸æ“šæ–‡ä»¶
 */
async function generateAllOhlcvData() {
  console.log('ğŸš€ Starting daily OHLCV data generation...');
  
  // ç¢ºä¿è¼¸å‡ºç›®éŒ„å­˜åœ¨
  if (!fs.existsSync(CONFIG.outputDir)) {
    fs.mkdirSync(CONFIG.outputDir, { recursive: true });
  }

  const symbols = loadUniverse();
  const generatedFiles = [];
  const days = CONFIG.ranges[CONFIG.defaultRange];
  
  console.log(`ğŸ“Š Generating OHLCV data for ${symbols.length} symbols (${days} days each)...`);
  
  for (const symbol of symbols) {
    const basePrice = getBasePrice(symbol);
    const ohlcvData = generateOhlcvData(symbol, days, basePrice);
    
    // æ ¼å¼ 1: SYMBOL.json (çµ¦ ohlcvApi)
    const filename1 = `${symbol.toUpperCase()}.json`;
    const filepath1 = path.join(CONFIG.outputDir, filename1);
    fs.writeFileSync(filepath1, JSON.stringify(ohlcvData, null, 2));
    generatedFiles.push(filename1);
    
    // æ ¼å¼ 2: symbol_period_days.json (çµ¦ precomputedOhlcvApi)
    const filename2 = `${symbol.toLowerCase()}_1d_${days}d.json`;
    const filepath2 = path.join(CONFIG.outputDir, filename2);
    fs.writeFileSync(filepath2, JSON.stringify(ohlcvData, null, 2));
    generatedFiles.push(filename2);
    
    console.log(`âœ… Generated ${symbol}: ${filename1} + ${filename2}`);
  }

  // ç”Ÿæˆç´¢å¼•æ–‡ä»¶
  const indexData = {
    generated: new Date().toISOString(),
    symbols: symbols,
    files: generatedFiles,
    totalFiles: generatedFiles.length,
    dataPoints: days,
    period: '1d',
    source: 'GitHub Actions Daily Update',
    note: 'OHLCV data for both ohlcvApi and precomputedOhlcvApi'
  };
  
  const indexPath = path.join(CONFIG.outputDir, 'index.json');
  fs.writeFileSync(indexPath, JSON.stringify(indexData, null, 2));
  
  console.log(`ğŸ“‹ Generated index.json with ${generatedFiles.length} files`);
  console.log('ğŸ‰ Daily OHLCV data generation completed!');
  
  return {
    totalFiles: generatedFiles.length,
    symbols: symbols.length,
    outputDir: CONFIG.outputDir,
    indexFile: 'index.json'
  };
}

/**
 * é©—è­‰ç”Ÿæˆçš„æ•¸æ“š
 */
function validateGeneratedData() {
  console.log('ğŸ” Validating generated OHLCV data...');
  
  const symbols = loadUniverse();
  let validFiles = 0;
  let invalidFiles = 0;
  
  for (const symbol of symbols) {
    // é©—è­‰æ ¼å¼ 1
    const filename1 = `${symbol.toUpperCase()}.json`;
    const filepath1 = path.join(CONFIG.outputDir, filename1);
    
    // é©—è­‰æ ¼å¼ 2
    const days = CONFIG.ranges[CONFIG.defaultRange];
    const filename2 = `${symbol.toLowerCase()}_1d_${days}d.json`;
    const filepath2 = path.join(CONFIG.outputDir, filename2);
    
    for (const [filename, filepath] of [[filename1, filepath1], [filename2, filepath2]]) {
      try {
        const data = JSON.parse(fs.readFileSync(filepath, 'utf8'));
        
        // é©—è­‰æ•¸æ“šçµæ§‹
        const requiredFields = ['timestamps', 'open', 'high', 'low', 'close', 'volume'];
        let isValid = true;
        
        for (const field of requiredFields) {
          if (!Array.isArray(data[field])) {
            console.error(`âŒ ${filename}: Missing ${field}`);
            isValid = false;
          }
        }
        
        if (isValid) {
          const length = data.timestamps.length;
          for (const field of requiredFields) {
            if (data[field].length !== length) {
              console.error(`âŒ ${filename}: Length mismatch for ${field}`);
              isValid = false;
            }
          }
        }
        
        if (isValid && data.timestamps.length >= 30) {
          validFiles++;
        } else {
          invalidFiles++;
          console.error(`âŒ ${filename}: Invalid or insufficient data`);
        }
        
      } catch (error) {
        invalidFiles++;
        console.error(`âŒ ${filename}: Parse error - ${error.message}`);
      }
    }
  }
  
  console.log(`ğŸ“Š Validation complete: ${validFiles} valid, ${invalidFiles} invalid`);
  return { validFiles, invalidFiles };
}

// ä¸»åŸ·è¡Œå‡½æ•¸
async function main() {
  try {
    console.log('ğŸš€ Daily OHLCV Data Generator');
    console.log('=' .repeat(50));
    
    const result = await generateAllOhlcvData();
    console.log('\nğŸ“Š Generation Summary:');
    console.log(`- Total files: ${result.totalFiles}`);
    console.log(`- Symbols: ${result.symbols}`);
    console.log(`- Output directory: ${result.outputDir}`);
    console.log(`- Index file: ${result.indexFile}`);
    
    console.log('\nğŸ” Validating data...');
    const validation = validateGeneratedData();
    
    if (validation.invalidFiles === 0) {
      console.log('\nğŸ‰ All OHLCV data files generated and validated successfully!');
      console.log('ğŸ“Š Both ohlcvApi and precomputedOhlcvApi formats ready.');
    } else {
      console.log(`\nâš ï¸  ${validation.invalidFiles} files have issues. Please check the logs above.`);
      process.exit(1);
    }
    
  } catch (error) {
    console.error('âŒ Error generating daily OHLCV data:', error);
    process.exit(1);
  }
}

// å¦‚æœç›´æ¥åŸ·è¡Œæ­¤è…³æœ¬
if (import.meta.url === `file://${process.argv[1]}`) {
  main();
}

export { generateAllOhlcvData, validateGeneratedData };